<!DOCTYPE html>
<html>
<head>
  <title>Cookie Sync Demo</title>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">

  <!-- Styles -->
  <link rel="stylesheet" href="https://www.w3schools.com/w3css/4/w3.css">
  <link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Roboto">
  <link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Montserrat">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/4.7.0/css/font-awesome.min.css">

  <style>
    .w3-sidebar a { font-family: "Roboto", sans-serif }
    body,h1,h2,h3,h4,h5,h6,.w3-wide { font-family: "Montserrat", sans-serif }
  </style>

  <!-- ✅ CMP -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/crypto-js/4.0.0/crypto-js.min.js"></script>
  <script src="https://cdn.cookielaw.org/scripttemplates/otSDKStub.js"
    type="text/javascript"
    charset="UTF-8"
    data-domain-script="0195138c-cdc8-738c-907d-131dad8db9ba-test">
  </script>

  <script>
    function OptanonWrapper() {
      console.log("✅ OneTrust consent granted");
    }
  </script>

  <!-- ✅ META PIXEL (MUST LOAD BEFORE ANALYTICS ✅) -->
  <script>
    !function(f,b,e,v,n,t,s)
    {if(f.fbq)return;n=f.fbq=function(){n.callMethod?
    n.callMethod.apply(n,arguments):n.queue.push(arguments)};
    if(!f._fbq)f._fbq=n;
    n.push=n;n.loaded=!0;n.version='2.0';
    n.queue=[];t=b.createElement(e);t.async=!0;
    t.src=v;s=b.getElementsByTagName(e)[0];
    s.parentNode.insertBefore(t,s)}(window, document,'script',
    'https://connect.facebook.net/en_US/fbevents.js');

    fbq('init', '101937259');
    fbq('track', 'PageView');

    console.log("✅ Meta Pixel Loaded:", typeof fbq);
  </script>

  <noscript>
    <img height="1" width="1" style="display:none"
      src="https://www.facebook.com/tr?id=101937259&ev=PageView&noscript=1"/>
  </noscript>

  <!-- ✅ DATALAYER -->
  <script>
    window.dataLayer = window.dataLayer || [];
    dataLayer.push({
      pageEnvironment: 'testPageEnvironment',
      pageContentType: 'pageContentType',
      pageName: 'Homepage',
      loggedIn: 'loggedIn',
      consentVersion: 'consentVersion',
      type: 'type',
      segment: 'segment',
      customerId:'customerId123'
    });
  </script>

  <!-- ✅ ANALYTICS.JS (LAST IN HEAD ✅) -->
  <script 
    src="https://web-analytics-js5-dot-uxlwqzc-cdip-sandbox-test.uc.r.appspot.com/static/analytics.js">
  </script>

</head>



<body class="w3-content" style="max-width:1200px">

  <div class="w3-container">
    <h2>✅ Cookie Sync Test Page</h2>
    <p>Open DevTools → Console + Application → Cookies</p>
  </div>

  <!-- ================================ -->
  <!-- ✅ REAL GOOGLE COOKIE SYNC -->
  <!-- ================================ -->
  <script>
    const GOOGLE_NID = "1686285891";

    async function sha1(message) {
      const data = new TextEncoder().encode(message);
      const hash = await crypto.subtle.digest("SHA-1", data);
      return Array.from(new Uint8Array(hash))
        .map(b => b.toString(16).padStart(2, "0"))
        .join("");
    }

    (async () => {
      const uid = "user_" + Math.random().toString(36).substring(2);
      const hashed = await sha1(uid);
      const redirect = encodeURIComponent(location.href);

      const pixelUrl =
        "https://cm.g.doubleclick.net/pixel?" +
        "google_nid=" + GOOGLE_NID +
        "&google_hm=" + hashed +
        "&redirect=" + redirect +
        "&tag_debug=1";

      console.log("✅ FORCING GOOGLE IDE SYNC:", pixelUrl);

      const iframe = document.createElement("iframe");
      iframe.src = pixelUrl;
      iframe.style.display = "none";
      iframe.width = 0;
      iframe.height = 0;

      document.body.appendChild(iframe);
    })();
  </script>

  <!-- ================================ -->
  <!-- ✅ DEBUG PANEL -->
  <!-- ================================ -->
  <script>
    setTimeout(() => {
      console.log("✅ fbq type:", typeof fbq);
      console.log("✅ document.cookie:", document.cookie);
      console.log("✅ _fbp exists:", document.cookie.includes("_fbp"));
    }, 3000);
  </script>

</body>
</html>
