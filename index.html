<!DOCTYPE html>
<html>
<head>
  <title>Cookie Sync + Meta Test</title>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">

  <link rel="stylesheet" href="https://www.w3schools.com/w3css/4/w3.css">
  <link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Roboto">
  <link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Montserrat">

  <style>
    body,h1,h2,h3,h4,h5,h6,.w3-wide {
      font-family: "Montserrat", sans-serif
    }
  </style>

  <!-- ✅ CMP -->
  <script src="https://cdn.cookielaw.org/scripttemplates/otSDKStub.js"
    type="text/javascript"
    charset="UTF-8"
    data-domain-script="0195138c-cdc8-738c-907d-131dad8db9ba-test">
  </script>

  <script>
    function OptanonWrapper() {
      console.log("✅ OneTrust Consent Granted");
      if (window.runGoogleCookieSync) {
        runGoogleCookieSync();
      }
    }
  </script>

  <!-- ✅ ADOBE -->
  <script src="https://assets.adobedtm.com/e72b4113c11a/dea835227b36/launch-5cc6da518e0d-development.min.js" async></script>

  <!-- ✅ DATA LAYER -->
  <script>
    window.dataLayer = window.dataLayer || [];
    dataLayer.push({
      pageName: 'Homepage',
      customerId: 'customerId123'
    });
  </script>
</head>

<body class="w3-content" style="max-width:1200px">

<!-- ✅✅✅ META PIXEL – FORCED LOAD (FIXES fbq UNDEFINED) -->
<script>
(function() {
  var s = document.createElement("script");
  s.async = true;
  s.src = "https://connect.facebook.net/en_US/fbevents.js";
  s.onload = function() {
    console.log("✅ META SCRIPT LOADED");
    fbq('init', '101937259');
    fbq('track', 'PageView');
    console.log("✅ fbq initialized");
  };
  document.head.appendChild(s);
})();
</script>

<noscript>
  <img height="1" width="1" style="display:none"
    src="https://www.facebook.com/tr?id=101937259&ev=PageView&noscript=1"/>
</noscript>

<!-- ✅ ANALYTICS.JS (AFTER META ✅) -->
<script 
  type="text/javascript"
  src="https://web-analytics-js5-dot-uxlwqzc-cdip-sandbox-test.uc.r.appspot.com/static/analytics.js?crossdomainflag=true&deleteprofile=true&multiDomainFlag=true&facebookCookieSyncFlag=true&googleCookieSyncFlag=true&automaticTracking=true&domainArray=[%22soundandsilence.in%22,%22www.soundandsilence.in%22,%22cookiesync-clickstream.vercel.app%22]&requiredPurposeIds=[%221%22,%223%22,%224%22]&dataLayer=dataLayer&backendBaseUrl=https%3A%2F%2Fweb-analytics-dot-uxlwqzc-cdip-sandbox-test.uc.r.appspot.com">
</script>

<!-- ✅ PAGE UI -->
<div class="w3-container w3-center w3-padding-32">
  <h1>✅ Cookie Sync + Meta Test Page</h1>
  <p>Check DevTools → Network → facebook / tr</p>
  <p>Console should show:</p>
  <pre>
✅ META SCRIPT LOADED
✅ fbq initialized
  </pre>
</div>

<!-- ========================================== -->
<!-- ✅✅✅ REAL GOOGLE COOKIE SYNC -->
<!-- ========================================== -->
<script>
const GOOGLE_NID = "1686285891";

async function sha1(message) {
  const data = new TextEncoder().encode(message);
  const hash = await crypto.subtle.digest("SHA-1", data);
  return Array.from(new Uint8Array(hash))
    .map(b => b.toString(16).padStart(2, "0"))
    .join("");
}

(async () => {
  const uid = "user_" + Math.random().toString(36).substring(2);
  const hashed = await sha1(uid);

  const redirect = encodeURIComponent(location.href);

  const pixelUrl =
    "https://cm.g.doubleclick.net/pixel?" +
    "google_nid=" + GOOGLE_NID +
    "&google_hm=" + hashed +
    "&redirect=" + redirect +
    "&tag_debug=1";

  console.log("✅ FIRING GOOGLE SYNC:", pixelUrl);

  const iframe = document.createElement("iframe");
  iframe.src = pixelUrl;
  iframe.style.display = "none";
  iframe.width = 0;
  iframe.height = 0;

  document.body.appendChild(iframe);
})();
</script>

</body>
</html>
