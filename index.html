<!DOCTYPE html>
<html>
  <head>
    <title>W3.CSS Template</title>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <link rel="stylesheet" href="https://www.w3schools.com/w3css/4/w3.css">
    <link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Roboto">
    <link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Montserrat">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/4.7.0/css/font-awesome.min.css">

    <style>
      .w3-sidebar a { font-family: "Roboto", sans-serif }
      body,h1,h2,h3,h4,h5,h6,.w3-wide { font-family: "Montserrat", sans-serif }
    </style>

    <!-- CMP -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/crypto-js/4.0.0/crypto-js.min.js"></script>
    <script src="https://cdn.cookielaw.org/scripttemplates/otSDKStub.js"
      type="text/javascript"
      charset="UTF-8"
      data-domain-script="0195138c-cdc8-738c-907d-131dad8db9ba-test">
    </script>

    <script>
      function OptanonWrapper() {
        console.log("‚úÖ OneTrust consent granted ‚Üí Running Google Cookie Sync");
        runGoogleCookieSync();
      }
    </script>

    <!-- Adobe Launch -->
    <script src="https://assets.adobedtm.com/e72b4113c11a/dea835227b36/launch-5cc6da518e0d-development.min.js" async></script>

    <!-- Data Layer -->
    <script>
      window.dataLayer = window.dataLayer || [];
      dataLayer.push({
        pageEnvironment: 'testPageEnvironment',
        pageContentType: 'pageContentType',
        pageName: 'Homepage',
        loggedIn: 'loggedIn',
        consentVersion: 'consentVersion',
        type: 'type',
        segment: 'segment',
        customerId:'customerId123'
      });
    </script>

    <!-- Analytics.js -->
    <script 
      type="text/javascript"
      src="https://web-analytics-js2-dot-uxlwqzc-cdip-sandbox-test.uc.r.appspot.com/static/analytics.js?crossdomainflag=true&deleteprofile=true&multiDomainFlag=true&facebookCookieSyncFlag=true&googleCookieSyncFlag=false&automaticTracking=true&domainArray=[%22soundandsilence.in%22,%22www.soundandsilence.in%22,%22cookiesync-clickstream-1mj2.vercel.app%22,%22cookiesync-clickstream.vercel.app%22]&requiredPurposeIds=[%221%22,%223%22,%224%22]&dataLayer=dataLayer&backendBaseUrl=https%3A%2F%2Fweb-analytics-dot-uxlwqzc-cdip-sandbox-test.uc.r.appspot.com">
    </script>

  </head>

<body class="w3-content" style="max-width:1200px">

<!-- GTM noscript -->
<noscript>
  <iframe src="https://www.googletagmanager.com/ns.html?id=GTM-NPRLPX6Q"
    height="0" width="0" style="display:none;visibility:hidden">
  </iframe>
</noscript>

<!-- Sidebar/menu -->
<nav class="w3-sidebar w3-bar-block w3-white w3-collapse w3-top"
     style="z-index:3;width:250px" id="mySidebar">
  <div class="w3-container w3-display-container w3-padding-16">
    <i onclick="w3_close()" class="fa fa-remove w3-hide-large w3-button w3-display-topright"></i>
    <h3 class="w3-wide"><b>LOGO</b></h3>
  </div>

  <div class="w3-padding-64 w3-large w3-text-grey" style="font-weight:bold">
    <a href="#" class="w3-bar-item w3-button">Shirts</a>
    <a href="#" class="w3-bar-item w3-button">Dresses</a>
    <a onclick="myAccFunc()" href="javascript:void(0)"
       class="w3-button w3-block w3-white w3-left-align" id="myBtn">
      Jeans <i class="fa fa-caret-down"></i>
    </a>
    <div id="demoAcc" class="w3-bar-block w3-hide w3-padding-large w3-medium">
      <a href="#" class="w3-bar-item w3-button w3-light-grey">
        <i class="fa fa-caret-right w3-margin-right"></i>Skinny
      </a>
      <a href="#" class="w3-bar-item w3-button">Relaxed</a>
      <a href="#" class="w3-bar-item w3-button">Bootcut</a>
      <a href="#" class="w3-bar-item w3-button">Straight</a>
    </div>
    <a href="#" class="w3-bar-item w3-button">Jackets</a>
    <a href="#" class="w3-bar-item w3-button">Gymwear</a>
    <a href="#" class="w3-bar-item w3-button">Blazers</a>
    <a href="#" class="w3-bar-item w3-button">Shoes</a>
  </div>

  <a href="#footer" class="w3-bar-item w3-button w3-padding">Contact</a>
  <a href="javascript:void(0)" class="w3-bar-item w3-button w3-padding"
     onclick="document.getElementById('newsletter').style.display='block'">
     Newsletter
  </a>
  <a href="#footer" class="w3-bar-item w3-button w3-padding">Subscribe</a>
</nav>

<header class="w3-bar w3-top w3-hide-large w3-black w3-xlarge">
  <div class="w3-bar-item w3-padding-24 w3-wide">LOGO</div>
  <a href="javascript:void(0)"
     class="w3-bar-item w3-button w3-padding-24 w3-right"
     onclick="w3_open()">
     <i class="fa fa-bars"></i>
  </a>
</header>

<div class="w3-overlay w3-hide-large" onclick="w3_close()" style="cursor:pointer" id="myOverlay"></div>

<div class="w3-main" style="margin-left:250px">
  <div class="w3-hide-large" style="margin-top:83px"></div>

  <header class="w3-container w3-xlarge">
    <p class="w3-left">Jeans</p>
    <p class="w3-right">
      <i class="fa fa-shopping-cart w3-margin-right"></i>
      <i class="fa fa-search"></i>
    </p>
  </header>

  <div class="w3-display-container w3-container">
    <img src="https://www.w3schools.com/w3images/jeans.jpg" alt="Jeans" style="width:100%">
    <div class="w3-display-topleft w3-text-white" style="padding:24px 48px">
      <h1 class="w3-jumbo w3-hide-small">New arrivals</h1>
      <h1 class="w3-hide-large w3-hide-medium">New arrivals</h1>
      <h1 class="w3-hide-small">COLLECTION 2016</h1>
      <p>
        <a href="#jeans" id="shopnow" class="w3-button w3-black w3-padding-large w3-large">
           SHOP NOW
        </a>
      </p>
    </div>
  </div>

  <div class="w3-container w3-text-grey" id="jeans">
    <p>8 items</p>
  </div>

  <!-- Subscribe section -->
  <div class="w3-container w3-black w3-padding-32">
    <h1>Subscribe</h1>
    <p>To get special offers and VIP treatment:</p>
    <p><input class="w3-input w3-border" type="text" placeholder="Enter e-mail" style="width:100%"></p>
    <button type="button" class="w3-button w3-red w3-margin-bottom">Subscribe</button>
  </div>

  <!-- Footer -->
  <footer class="w3-padding-64 w3-light-grey w3-small w3-center" id="footer">
    <button id="ot-sdk-btn" class="ot-sdk-show-settings">Cookie Settings</button>
    <div id="sync-status" style="margin-top:20px; padding:10px; background:#f0f0f0; border-radius:5px;">
      <strong>Cookie Sync Status:</strong> <span id="status-text">Initializing...</span>
    </div>
  </footer>

</div>

<!-- Newsletter Modal -->
<div id="newsletter" class="w3-modal">
  <div class="w3-modal-content w3-animate-zoom" style="padding:32px">
    <div class="w3-container w3-white w3-center">
      <h1 class="w3-wide">NEWSLETTER</h1>
      <p>Join our mailing list to receive updates on new arrivals and special offers.</p>
      <input class="w3-input w3-border" type="text" placeholder="Enter e-mail">
      <button type="button" class="w3-button w3-padding-large w3-red w3-margin-bottom"
        onclick="document.getElementById('newsletter').style.display='none'">Subscribe</button>
    </div>
  </div>
</div>

<script>
// UI functions
function myAccFunc() {
  var x = document.getElementById("demoAcc");
  if (x.className.indexOf("w3-show") == -1) {
    x.className += " w3-show";
  } else {
    x.className = x.className.replace(" w3-show", "");
  }
}
function w3_open() {
  document.getElementById("mySidebar").style.display = "block";
  document.getElementById("myOverlay").style.display = "block";
}
function w3_close() {
  document.getElementById("mySidebar").style.display = "none";
  document.getElementById("myOverlay").style.display = "none";
}
</script>

<!-- ========================================== -->
<!-- FIXED GOOGLE COOKIE SYNC WITH IDE COOKIE -->
<!-- ========================================== -->
<script>
(function () {
  console.log("üî• Google DoubleClick Cookie Sync Script Loaded");

  const GOOGLE_NID = "1686285891";
  let syncInitiated = false;

  // HELPER: Set cookie with proper attributes
  function setCookie(name, value, days) {
    const d = new Date();
    d.setTime(d.getTime() + (days * 24 * 60 * 60 * 1000));
    const expires = "expires=" + d.toUTCString();
    // Use SameSite=None; Secure for cross-domain
    document.cookie = name + "=" + value + ";" + expires + ";path=/;SameSite=None;Secure";
    console.log("‚úÖ Cookie Set:", name, "=", value);
  }

  // HELPER: Get cookie value
  function getCookie(name) {
    const nameEQ = name + "=";
    const ca = document.cookie.split(';');
    for (let i = 0; i < ca.length; i++) {
      let c = ca[i];
      while (c.charAt(0) === ' ') c = c.substring(1, c.length);
      if (c.indexOf(nameEQ) === 0) return c.substring(nameEQ.length, c.length);
    }
    return null;
  }

  // HELPER: Generate unique ID
  function generateId(prefix) {
    return prefix + "_" + Date.now() + "_" + Math.random().toString(36).substr(2, 9);
  }

  // HELPER: SHA-1 hash
  async function sha1hex(input) {
    const data = new TextEncoder().encode(input);
    const hash = await crypto.subtle.digest("SHA-1", data);
    return [...new Uint8Array(hash)]
      .map(b => b.toString(16).padStart(2, "0"))
      .join("");
  }

  // Update status on page
  function updateStatus(message) {
    const statusEl = document.getElementById('status-text');
    if (statusEl) {
      statusEl.textContent = message;
    }
    console.log("üìä Status:", message);
  }

  // MAIN COOKIE SYNC FUNCTION
  async function runGoogleCookieSync() {
    if (syncInitiated) {
      console.log("‚ö†Ô∏è Cookie sync already initiated");
      return;
    }
    syncInitiated = true;

    console.log("üöÄ Starting Google Cookie Sync...");
    updateStatus("Starting sync...");

    // 1. Generate or retrieve User ID
    let userId = getCookie('user_id');
    if (!userId) {
      userId = generateId('user');
      setCookie('user_id', userId, 365);
      console.log("üÜï New User ID created:", userId);
    } else {
      console.log("‚ôªÔ∏è Existing User ID:", userId);
    }

    // 2. Generate IDE (Internal Data Exchange) cookie - THIS WAS MISSING!
    let ide = getCookie('IDE');
    if (!ide) {
      ide = generateId('ide');
      setCookie('IDE', ide, 365);
      console.log("üÜï IDE Cookie created:", ide);
    } else {
      console.log("‚ôªÔ∏è Existing IDE:", ide);
    }

    // 3. Hash the user ID for Google
    const hashedUserId = await sha1hex(userId);
    console.log("üîê Hashed User ID:", hashedUserId);

    // 4. Build the DoubleClick sync URL
    // CRITICAL: For 302 redirect to work, you need a backend endpoint
    // The redirect should come from YOUR server, not directly hitting DoubleClick
    
    const currentHost = window.location.origin;
    const backendSyncUrl = currentHost + "/api/cookie-sync?uid=" + userId + "&ide=" + ide;

    console.log("üì° Triggering sync via backend:", backendSyncUrl);
    updateStatus("Syncing with DoubleClick...");

    // 5. Create iframe to trigger sync
    const iframe = document.createElement("iframe");
    iframe.src = backendSyncUrl;
    iframe.width = 1;
    iframe.height = 1;
    iframe.style.display = "none";
    iframe.style.position = "absolute";
    iframe.style.top = "-9999px";
    
    iframe.onload = function() {
      console.log("‚úÖ Cookie sync iframe loaded");
      updateStatus("Sync completed!");
      
      // Set sync status cookie
      setCookie('sync_status', 'complete', 365);
      
      // Log all cookies
      setTimeout(() => {
        console.log("üìã All Cookies:", document.cookie);
      }, 1000);
    };

    iframe.onerror = function() {
      console.error("‚ùå Cookie sync iframe failed");
      updateStatus("Sync failed - check console");
    };

    document.body.appendChild(iframe);
    
    // Also set a cookie to mark sync attempt
    setCookie('sync_initiated', new Date().toISOString(), 365);
  }

  // Make function globally accessible for OptanonWrapper
  window.runGoogleCookieSync = runGoogleCookieSync;

  // Auto-run on page load (fallback if OneTrust doesn't trigger)
  window.addEventListener("load", function() {
    updateStatus("Page loaded, waiting for consent...");
    // Wait a bit for OneTrust
    setTimeout(function() {
      if (!syncInitiated) {
        console.log("‚è∞ Auto-triggering cookie sync (OneTrust delay)");
        runGoogleCookieSync();
      }
    }, 2000);
  });

})();
</script>

</body>
</html>
