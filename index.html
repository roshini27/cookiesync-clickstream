<!DOCTYPE html>
<html>
<head>
    <meta charset="UTF-8">
    <title>Google Cookie Sync Test</title>
    <meta name="viewport" content="width=device-width, initial-scale=1">

    <!-- W3 Layout CSS -->
    <link rel="stylesheet" href="https://www.w3schools.com/w3css/4/w3.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/4.7.0/css/font-awesome.min.css">

    <style>
        body,h1,h2,h3,h4,h5 { font-family: "Montserrat", sans-serif }
        .w3-sidebar a { font-family: "Roboto", sans-serif }
    </style>
</head>

<body class="w3-content" style="max-width:1200px">

<h3 class="w3-center">Google DoubleClick Cookie Sync Test (Vercel)</h3>
<p class="w3-center w3-text-green">
    This page fires the DoubleClick sync on load.
</p>

<hr>

<div class="w3-container">
    <p><b>Status:</b></p>
    <pre id="logBox" class="w3-padding w3-light-grey" style="height:120px; overflow:auto;"></pre>
</div>

<script>
// Utility: SHA-1 → HEX
async function sha1Hex(message) {
    const encoder = new TextEncoder();
    const data = encoder.encode(message);
    const hashBuffer = await crypto.subtle.digest("SHA-1", data);
    return Array.from(new Uint8Array(hashBuffer))
        .map(b => b.toString(16).padStart(2, "0"))
        .join("");
}

// Logging helper
function log(msg) {
    document.getElementById("logBox").textContent += msg + "\n";
    console.log(msg);
}

// Google Cookie Sync Trigger
async function runGoogleSync() {
    log("Starting Google Cookie Sync...");

    const GOOGLE_NID = "1686285891";  // numeric only

    // Create a random ID for hashing
    const rawId = "u_" + crypto.randomUUID();
    const hashedId = await sha1Hex(rawId);

    log("Generated SHA-1 user ID: " + hashedId);

    const redirectUrl = encodeURIComponent("https://example.com/sync_done");

    const pixelUrl =
        "https://cm.g.doubleclick.net/pixel?" +
        "google_nid=" + GOOGLE_NID +
        "&google_cm=1" +
        "&google_hm=" + encodeURIComponent(hashedId) +
        "&ext=1" +
        "&tag_debug=1" +
        "&redirect=" + redirectUrl;

    log("Pixel URL: " + pixelUrl);

    // Use an iframe (best method for cookie sync)
    const iframe = document.createElement("iframe");
    iframe.src = pixelUrl;
    iframe.width = 1;
    iframe.height = 1;
    iframe.style.display = "none";
    document.body.appendChild(iframe);

    log("→ Cookie Sync request sent.");
}

// Fire sync AFTER page loads fully
window.addEventListener("load", () => {
    log("Page loaded. Triggering sync...");
    runGoogleSync();
});
</script>

</body>
</html>
